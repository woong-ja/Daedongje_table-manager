<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>통합 테이블 관리</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #193b59; color: white; }
    h1 { margin: 10px 0; }
    .section h2 { color: #f5dd8f; font-size: 20px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; margin-top: 20px; }
    .section { display: flex; flex-direction: column; align-items: center; }
    .tables { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(2, 100px); gap: 10px; }
    .table { display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 5px; background-color: white; color: black; border: 2px solid #f5dd8f; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .table.occupied { background-color: #d64040; color: white; }
    .table.occupied .details { color: #f5dd8f; }
    .table-id { font-size: 16px; margin-bottom: 5px; }
    .details { font-size: 12px; text-align: center; }
  </style>
</head>
<body>
  <h1>통합 테이블 관리 대시보드</h1>
  <div class="grid">
    <div class="section">
      <h2>A 구역</h2>
      <div class="tables" id="A"></div>
    </div>
    <div class="section">
      <h2>B 구역</h2>
      <div class="tables" id="B"></div>
    </div>
    <div class="section">
      <h2>C 구역</h2>
      <div class="tables" id="C"></div>
    </div>
    <div class="section">
      <h2>D 구역</h2>
      <div class="tables" id="D"></div>
    </div>
  </div>

  <script>
    const sections = ["A", "B", "C", "D"];
    const ws = new WebSocket("wss://당신의-render-주소.onrender.com"); // ⚠️ 이 부분을 당신의 주소로 바꾸세요

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'init') {
        for (const tableId in data.tables) {
          updateTableUI(tableId, data.tables[tableId]);
        }
      } else if (data.type === 'table-update' || data.type === 'order-update') {
        updateTableUI(data.tableId, data.tableData);
      }
    };

    function updateTableUI(tableId, tableData) {
      const tableElement = document.getElementById(tableId);
      if (!tableElement) {
        // 이 부분은 초기화 로직에만 사용되므로, 웹소켓 업데이트에서는 실행되지 않도록 제거했습니다.
        return; 
      }

      const details = tableElement.querySelector('.details');
      if (tableData.isOccupied) {
        tableElement.classList.add("occupied");
        const elapsedTime = Math.floor((Date.now() - tableData.startTime) / 60000);
        details.innerHTML = `점유 시간: ${elapsedTime}분<br>총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`;
      } else {
        tableElement.classList.remove("occupied");
        details.innerHTML = "빈 테이블";
      }
    }

    // 이 반복문이 초기 테이블 UI를 한 번만 만듭니다.
    sections.forEach(section => {
      const container = document.getElementById(section);
      for (let i = 1; i <= 6; i++) {
        const tableId = section + "-" + i;
        const table = document.createElement("div");
        table.id = tableId;
        table.className = "table";
        table.innerHTML = `<span class="table-id">${tableId}</span><div class="details"></div>`;
        
        table.addEventListener("click", () => {
          const tableData = getTableData(tableId);
          if (tableData && tableData.isOccupied) {
            const confirmation = confirm(`${tableId} 테이블을 정산하고 초기화하시겠습니까?\n총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`);
            if (confirmation) {
              ws.send(JSON.stringify({ type: 'checkout', tableId: tableId }));
            }
          }
        });
        
        container.appendChild(table);
      }
    });

    // 모든 테이블 데이터를 가져오는 임시 함수
    function getTableData(tableId) {
        // 이 함수는 초기 접속 시 받은 데이터를 사용합니다.
        // 실시간 업데이트를 위해선 서버에 요청하거나, 데이터를 로컬에 저장하는 로직이 필요합니다.
        // 현재는 서버에서 init 메시지를 받아 초기화할 때 테이블 데이터를 가져옵니다.
        // 이 로직은 이미 updateTableUI 함수에서 처리하고 있습니다.
        // 이 코드는 클릭 이벤트에서만 사용되므로, 현재는 비워두셔도 됩니다.
        // 하지만 클릭 이벤트가 제대로 작동하도록 아래 코드를 추가합니다.
        const tableElement = document.getElementById(tableId);
        if (tableElement) {
          const isOccupied = tableElement.classList.contains('occupied');
          const totalPriceText = tableElement.querySelector('.details').textContent;
          const totalPrice = parseInt(totalPriceText.match(/총 금액: (\d+)/)?.[1].replace(/,/g, '') || 0);
          return { isOccupied, totalPrice };
        }
        return { isOccupied: false, totalPrice: 0 };
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>통합 테이블 관리</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #193b59; color: white; }
    h1 { margin: 10px 0; }
    .section h2 { color: #f5dd8f; font-size: 20px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; margin-top: 20px; }
    .section { display: flex; flex-direction: column; align-items: center; }
    .tables { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(2, 100px); gap: 10px; }
    .table { display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 5px; background-color: white; color: black; border: 2px solid #f5dd8f; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .table.occupied { background-color: #d64040; color: white; }
    .table.pending { background-color: #f5dd8f; color: black; }
    .table.occupied .details { color: #f5dd8f; }
    .table-id { font-size: 16px; margin-bottom: 5px; }
    .details { font-size: 12px; text-align: center; }
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .modal-content { background-color: #193b59; padding: 20px; border: 2px solid #f5dd8f; width: 80%; max-width: 400px; border-radius: 10px; text-align: left; position: relative; }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 20px; }
    .order-list li { margin-bottom: 5px; }
    .modal-buttons { margin-top: 20px; text-align: center; }
    .modal-buttons button { padding: 10px 20px; margin: 0 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #confirm-button { background-color: #4CAF50; color: white; }
    #cancel-order-button { background-color: #f4b400; color: black; }
    #checkout-button { background-color: #f44336; color: white; }
    .management-tabs { display: flex; gap: 20px; margin-top: 20px; }
    .management-tab { cursor: pointer; padding: 10px 20px; background-color: #315b85; border-radius: 8px; }
    .management-tab.active { background-color: #4a759e; }
    #menu-management, #sales-container { display: none; width: 80%; max-width: 800px; margin-top: 20px; }
    .menu-item-manage { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #5d8ab5; }
    .sold-out-toggle { background-color: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    .sold-out-toggle.available { background-color: #4CAF50; }
    .sales-record { background-color: #315b85; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
    .sales-record h3 { margin: 0 0 10px 0; color: #f5dd8f; }
    .sales-record p, .sales-record ul { margin: 5px 0; }
    .sales-record ul { list-style: disc; padding-left: 20px; }
  </style>
</head>
<body>
  <script>
    // 페이지가 로드되기 전에 즉시 실행되는 로그인 스크립트
    (function() {
      const managerId = "안현정"; // 관리자 ID
      const managerPw = "모쏠탈출";  // 관리자 비밀번호

      const enteredId = prompt("관리자 아이디를 입력하세요:");
      // 사용자가 '취소'를 누른 경우 (null) 또는 아무것도 입력하지 않은 경우
      if (enteredId === null || enteredId === "") {
        document.body.innerHTML = '<h1 style="color: white; text-align: center; padding-top: 50px;">로그인이 취소되었습니다.</h1>';
        throw new Error("Login canceled by user."); // 페이지 로딩 중단
      }

      const enteredPw = prompt("관리자 비밀번호를 입력하세요:");
      if (enteredPw === null) {
         document.body.innerHTML = '<h1 style="color: white; text-align: center; padding-top: 50px;">로그인이 취소되었습니다.</h1>';
        throw new Error("Login canceled by user."); // 페이지 로딩 중단
      }

      if (enteredId !== managerId || enteredPw !== managerPw) {
        alert("아이디 또는 비밀번호가 일치하지 않습니다!");
        document.body.innerHTML = '<h1 style="color: white; text-align: center; padding-top: 50px;">접근 권한이 없습니다.</h1>';
        throw new Error("Login failed."); // 페이지의 나머지 부분 실행을 중단
      }
      // 인증 성공 시, 아무것도 하지 않고 스크립트가 종료되어 나머지 페이지가 정상적으로 로드됨
    })();
  </script>

  <h1>통합 테이블 관리 대시보드</h1>
  
  <div class="management-tabs">
    <div class="management-tab active" data-tab="tables">테이블 관리</div>
    <div class="management-tab" data-tab="menu-management">메뉴 관리</div>
    <div class="management-tab" data-tab="sales">매출</div>
  </div>

  <div id="tables-container" class="grid">
    <div class="section"><h2>A 구역</h2><div class="tables" id="A"></div></div>
    <div class="section"><h2>B 구역</h2><div class="tables" id="B"></div></div>
    <div class="section"><h2>C 구역</h2><div class="tables" id="C"></div></div>
    <div class="section"><h2>D 구역</h2><div class="tables" id="D"></div></div>
  </div>

  <div id="menu-management" style="display:none;">
    <h2>메뉴 관리</h2>
    <div id="menu-list-manage"></div>
  </div>

  <div id="sales-container" style="display:none;">
    <h2>매출 현황</h2>
    <p><strong>총 매출: <span id="total-revenue">0</span>원</strong></p>
    <hr style="border-color: #5d8ab5; width: 100%;">
    <h3>테이블별 정산 내역</h3>
    <div id="sales-by-table-list"></div>
  </div>

  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2 id="modal-table-id"></h2>
      <h3>주문 내역</h3>
      <ul id="modal-order-list" class="order-list"></ul>
      <p><strong>총 금액:</strong> <span id="modal-total-price"></span>원</p>
      <div class="modal-buttons">
        <button id="confirm-button" style="display:none;">입금 확인</button>
        <button id="cancel-order-button" style="display:none;">주문 취소</button>
        <button id="checkout-button" style="display:none;">정산 완료</button>
      </div>
    </div>
  </div>

  <script>
    const sections = ["A", "B", "C", "D"];
    const ws = new WebSocket("wss://daedongje-table-manager.onrender.com");
    const tables = {};
    let menu = [];
    const modal = document.getElementById("myModal");
    const closeButton = document.querySelector(".close-button");
    const modalTableId = document.getElementById("modal-table-id");
    const modalOrderList = document.getElementById("modal-order-list");
    const modalTotalPrice = document.getElementById("modal-total-price");
    const confirmButton = document.getElementById("confirm-button");
    const checkoutButton = document.getElementById("checkout-button");
    const cancelOrderButton = document.getElementById("cancel-order-button");

    const tabs = document.querySelectorAll('.management-tab');
    const tablesContainer = document.getElementById('tables-container');
    const menuManagementContainer = document.getElementById('menu-management');
    const salesContainer = document.getElementById('sales-container');
    const menuListManage = document.getElementById('menu-list-manage');
    const totalRevenue = document.getElementById('total-revenue');
    const salesByTableList = document.getElementById('sales-by-table-list');
    
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'init') {
        Object.assign(tables, data.tables);
        menu = data.menu;
        renderTables();
        renderMenuManage();
        fetchSalesData();
      } else if (data.type === 'table-update') {
        tables[data.tableId] = data.tableData;
        updateTableUI(data.tableId);
        if (data.tableData.status === 'free') {
          fetchSalesData();
        }
      } else if (data.type === 'menu-update') {
        menu = data.menu;
        renderMenuManage();
      }
    };

    function renderTables() {
      sections.forEach(section => {
        const container = document.getElementById(section);
        container.innerHTML = '';
        for (let i = 1; i <= 6; i++) {
          const tableId = `${section}-${i}`;
          const table = document.createElement("div");
          table.id = tableId;
          table.className = "table";
          table.innerHTML = `<span class="table-id">${tableId}</span><div class="details"></div>`;
          container.appendChild(table);
          table.addEventListener("click", () => showModal(tableId));
        }
      });
      for (const tableId in tables) {
        updateTableUI(tableId);
      }
    }

    function updateTableUI(tableId) {
      const tableElement = document.getElementById(tableId);
      const tableData = tables[tableId];
      if (!tableElement || !tableData) return;

      const details = tableElement.querySelector('.details');
      tableElement.classList.remove("occupied", "pending");

      if (tableData.status === 'occupied') {
        tableElement.classList.add("occupied");
        let elapsedTime = tableData.startTime ? Math.floor((Date.now() - tableData.startTime) / 60000) : '---';
        details.innerHTML = `점유 시간: ${elapsedTime}분<br>총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`;
      } else if (tableData.status === 'pending') {
        tableElement.classList.add("pending");
        details.innerHTML = `입금 대기<br>총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`;
      } else {
        details.innerHTML = "빈 테이블";
      }
    }

    function showModal(tableId) {
      const tableData = tables[tableId];
      modalTableId.textContent = tableId;
      modalOrderList.innerHTML = '';
      
      if (tableData.orders && tableData.orders.length > 0) {
        tableData.orders.forEach((order, index) => {
          const orderTitle = document.createElement('h4');
          orderTitle.style.cssText = 'margin-top: 10px; margin-bottom: 5px;';
          const orderDate = new Date(order.time);
          const formattedTime = orderDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
          orderTitle.textContent = `주문 #${index + 1} (${formattedTime})`;
          modalOrderList.appendChild(orderTitle);

          const orderItemsList = document.createElement('ul');
          orderItemsList.style.cssText = 'list-style: disc; padding-left: 20px; color: #fff;';
          if (order.items) {
            for (const itemName in order.items) {
              const item = order.items[itemName];
              const li = document.createElement('li');
              li.textContent = `${itemName} x ${item.quantity}`;
              orderItemsList.appendChild(li);
            }
          }
          modalOrderList.appendChild(orderItemsList);
        });
      } else {
        modalOrderList.innerHTML = '<li>주문 내역 없음</li>';
      }

      modalTotalPrice.textContent = tableData.totalPrice.toLocaleString('ko-KR');
      confirmButton.style.display = 'none';
      checkoutButton.style.display = 'none';
      cancelOrderButton.style.display = 'none';

      if (tableData.status === 'pending') {
        confirmButton.style.display = 'inline-block';
        cancelOrderButton.style.display = 'inline-block';
      } else if (tableData.status === 'occupied') {
        checkoutButton.style.display = 'inline-block';
      }
      modal.style.display = "flex";
    }

    closeButton.onclick = () => { modal.style.display = "none"; };
    window.onclick = (event) => { if (event.target === modal) modal.style.display = "none"; };

    confirmButton.onclick = () => {
      const tableId = modalTableId.textContent;
      ws.send(JSON.stringify({ type: 'confirm-order', tableId: tableId }));
      modal.style.display = 'none';
    };

    cancelOrderButton.onclick = () => {
      const tableId = modalTableId.textContent;
      if (confirm(`'${tableId}' 테이블의 마지막 주문을 취소하시겠습니까?`)) {
        ws.send(JSON.stringify({ type: 'cancel-order', tableId: tableId }));
        modal.style.display = 'none';
      }
    };

    checkoutButton.onclick = () => {
      const tableId = modalTableId.textContent;
      if (confirm(`${tableId} 테이블을 정산하고 초기화하시겠습니까?`)) {
        ws.send(JSON.stringify({ type: 'checkout', tableId: tableId }));
        modal.style.display = 'none';
      }
    };

    setInterval(() => {
      for (const tableId in tables) {
        if (tables[tableId].status === 'occupied') updateTableUI(tableId);
      }
    }, 60000);

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.dataset.tab;
            tablesContainer.style.display = 'none';
            menuManagementContainer.style.display = 'none';
            salesContainer.style.display = 'none';
            
            if (target === 'tables') tablesContainer.style.display = 'grid';
            else if (target === 'menu-management') menuManagementContainer.style.display = 'block';
            else if (target === 'sales') {
                salesContainer.style.display = 'block';
                fetchSalesData();
            }
        });
    });

    function renderMenuManage() {
        menuListManage.innerHTML = '';
        menu.forEach((item) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item-manage';
            itemDiv.innerHTML = `<span class="menu-item-name">${item.name}</span><button class="sold-out-toggle ${item.isSoldOut ? '' : 'available'}">${item.isSoldOut ? '품절' : '판매중'}</button>`;
            itemDiv.querySelector('.sold-out-toggle').addEventListener('click', () => {
                item.isSoldOut = !item.isSoldOut;
                ws.send(JSON.stringify({ type: 'update-menu', menu: menu }));
            });
            menuListManage.appendChild(itemDiv);
        });
    }

    function fetchSalesData() {
        fetch('/api/sales')
            .then(response => response.json())
            .then(salesData => {
                const totalSales = salesData.reduce((sum, sale) => sum + sale.totalPrice, 0);
                totalRevenue.textContent = totalSales.toLocaleString('ko-KR');
                salesByTableList.innerHTML = '';
                
                salesData.reverse().forEach(sale => {
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'sales-record';
                    const checkoutTime = new Date(sale.checkoutTime).toLocaleTimeString('ko-KR');
                    let itemsHtml = '<ul>';
                    sale.orders.forEach(order => {
                        for (const itemName in order.items) {
                            itemsHtml += `<li>${itemName} x ${order.items[itemName].quantity}</li>`;
                        }
                    });
                    itemsHtml += '</ul>';
                    recordDiv.innerHTML = `<h3>${sale.tableId} 테이블 (정산: ${checkoutTime})</h3><p><strong>총 결제 금액: ${sale.totalPrice.toLocaleString('ko-KR')}원</strong></p>${itemsHtml}`;
                    salesByTableList.appendChild(recordDiv);
});
                if (salesData.length === 0) {
                  salesByTableList.innerHTML = '<p>아직 정산이 완료된 테이블이 없습니다.</p>';
                }
            })
            .catch(e => console.error('매출 데이터 불러오기 오류:', e));
    }
  </script>
</body>
</html>

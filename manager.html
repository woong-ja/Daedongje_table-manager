<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>통합 테이블 관리</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #193b59; color: white; }
    h1 { margin: 10px 0; }
    .section h2 { color: #f5dd8f; font-size: 20px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; margin-top: 20px; }
    .section { display: flex; flex-direction: column; align-items: center; }
    .tables { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(2, 100px); gap: 10px; }
    .table { display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 5px; background-color: white; color: black; border: 2px solid #f5dd8f; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .table.occupied { background-color: #d64040; color: white; }
    .table.occupied .details { color: #f5dd8f; }
    .table-id { font-size: 16px; margin-bottom: 5px; }
    .details { font-size: 12px; text-align: center; }
  </style>
</head>
<body>
  <h1>통합 테이블 관리 대시보드</h1>
  <div class="grid">
    <div class="section">
      <h2>A 구역</h2>
      <div class="tables" id="A"></div>
    </div>
    <div class="section">
      <h2>B 구역</h2>
      <div class="tables" id="B"></div>
    </div>
    <div class="section">
      <h2>C 구역</h2>
      <div class="tables" id="C"></div>
    </div>
    <div class="section">
      <h2>D 구역</h2>
      <div class="tables" id="D"></div>
    </div>
  </div>

  <script>
    const sections = ["A", "B", "C", "D"];
    const ws = new WebSocket("wss://daedongje-table-manager.onrender.com"); // ⚠️ 당신의 주소로 자동 수정했습니다.

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'init') {
        for (const tableId in data.tables) {
          updateTableUI(tableId, data.tables[tableId]);
        }
      } else if (data.type === 'table-update' || data.type === 'order-update') {
        updateTableUI(data.tableId, data.tableData);
      }
    };

    function updateTableUI(tableId, tableData) {
      let tableElement = document.getElementById(tableId);
      if (!tableElement) {
        const [section, number] = tableId.split('-');
        const container = document.getElementById(section);
        if (container) {
          tableElement = document.createElement("div");
          tableElement.id = tableId;
          tableElement.className = "table";
          tableElement.innerHTML = `<span class="table-id">${tableId}</span><div class="details"></div>`;
          container.appendChild(tableElement);
          
          tableElement.addEventListener("click", () => {
            if (tableData.isOccupied) {
              const confirmation = confirm(`${tableId} 테이블을 정산하고 초기화하시겠습니까?\n총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`);
              if (confirmation) {
                ws.send(JSON.stringify({ type: 'checkout', tableId: tableId }));
              }
            }
          });
        }
      }

      if (tableElement) {
        const details = tableElement.querySelector('.details');
        if (tableData.isOccupied) {
          tableElement.classList.add("occupied");
          const elapsedTime = Math.floor((Date.now() - tableData.startTime) / 60000);
          details.innerHTML = `점유 시간: ${elapsedTime}분<br>총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`;
        } else {
          tableElement.classList.remove("occupied");
          details.innerHTML = "빈 테이블";
        }
      }
    }

    // 이 반복문은 초기 테이블 UI를 한 번만 만듭니다.
    sections.forEach(section => {
      const container = document.getElementById(section);
      for (let i = 1; i <= 6; i++) {
        const tableId = section + "-" + i;
        const table = document.createElement("div");
        table.id = tableId;
        table.className = "table";
        table.innerHTML = `<span class="table-id">${tableId}</span><div class="details"></div>`;
        container.appendChild(table);

        table.addEventListener("click", () => {
          const tableData = {
              isOccupied: table.classList.contains('occupied'),
              totalPrice: parseInt(table.querySelector('.details').textContent.match(/총 금액: (\d+)/)?.[1].replace(/,/g, '') || 0),
              // startTime은 서버에서 관리하므로 클라이언트에서는 알 필요가 없습니다.
          };
          
          if (tableData.isOccupied) {
            const confirmation = confirm(`${tableId} 테이블을 정산하고 초기화하시겠습니까?\n총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`);
            if (confirmation) {
              ws.send(JSON.stringify({ type: 'checkout', tableId: tableId }));
            }
          }
        });
      }
    });
  </script>
</body>
</html>
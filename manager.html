<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>통합 테이블 관리</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #193b59; color: white; }
    h1 { margin: 10px 0; }
    .section h2 { color: #f5dd8f; font-size: 20px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; margin-top: 20px; }
    .section { display: flex; flex-direction: column; align-items: center; }
    .tables { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(2, 100px); gap: 10px; }
    .table { display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 5px; background-color: white; color: black; border: 2px solid #f5dd8f; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .table.occupied { background-color: #d64040; color: white; }
    .table.pending { background-color: #f5dd8f; color: black; }
    .table.occupied .details { color: #f5dd8f; }
    .table-id { font-size: 16px; margin-bottom: 5px; }
    .details { font-size: 12px; text-align: center; }
    /* Modal styles */
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .modal-content { background-color: #193b59; padding: 20px; border: 2px solid #f5dd8f; width: 80%; max-width: 400px; border-radius: 10px; text-align: left; position: relative; }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 20px; }
    .close-button:hover, .close-button:focus { color: white; text-decoration: none; }
    .order-list li { margin-bottom: 5px; }
    .modal-buttons { margin-top: 20px; text-align: center; }
    .modal-buttons button { padding: 10px 20px; margin: 0 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #confirm-button { background-color: #4CAF50; color: white; }
    #checkout-button { background-color: #f44336; color: white; }
    /* New styles for menu and stats */
    .management-tabs { display: flex; gap: 20px; margin-top: 20px; }
    .management-tab { cursor: pointer; padding: 10px 20px; background-color: #315b85; border-radius: 8px; }
    .management-tab.active { background-color: #4a759e; }
    #menu-management, #statistics { display: none; width: 80%; max-width: 800px; margin-top: 20px; }
    .menu-item-manage { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #5d8ab5; }
    .menu-item-name { font-weight: bold; }
    .sold-out-toggle { background-color: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    .sold-out-toggle.available { background-color: #4CAF50; }
    .stats-item { padding: 10px; border-bottom: 1px solid #5d8ab5; }
    .reset-button { margin-top: 20px; padding: 10px 20px; border: none; border-radius: 5px; background-color: #f44336; color: white; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <h1>통합 테이블 관리 대시보드</h1>
  
  <div class="management-tabs">
    <div class="management-tab active" data-tab="tables">테이블 관리</div>
    <div class="management-tab" data-tab="menu-management">메뉴 관리</div>
    <div class="management-tab" data-tab="statistics">통계</div>
  </div>

  <div id="tables-container" class="grid">
    <div class="section">
      <h2>A 구역</h2>
      <div class="tables" id="A"></div>
    </div>
    <div class="section">
      <h2>B 구역</h2>
      <div class="tables" id="B"></div>
    </div>
    <div class="section">
      <h2>C 구역</h2>
      <div class="tables" id="C"></div>
    </div>
    <div class="section">
      <h2>D 구역</h2>
      <div class="tables" id="D"></div>
    </div>
  </div>

  <div id="menu-management" style="display:none;">
    <h2>메뉴 관리</h2>
    <div id="menu-list-manage"></div>
  </div>

  <div id="statistics" style="display:none;">
    <h2>통계</h2>
    <p>총 매출: <strong id="total-revenue">0</strong>원</p>
    <h3>가장 많이 팔린 메뉴</h3>
    <div id="top-selling-items"></div>
    <button id="reset-stats-button" class="reset-button">통계 초기화</button>
  </div>


  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2 id="modal-table-id"></h2>
      <h3>주문 내역</h3>
      <ul id="modal-order-list" class="order-list"></ul>
      <p><strong>총 금액:</strong> <span id="modal-total-price"></span>원</p>
      <div class="modal-buttons">
        <button id="confirm-button" style="display:none;">입금 확인</button>
        <button id="checkout-button" style="display:none;">정산 완료</button>
      </div>
    </div>
  </div>

  <script>
    const sections = ["A", "B", "C", "D"];
    const ws = new WebSocket("wss://daedongje-table-manager.onrender.com");
    const tables = {};
    let menu = [];
    const modal = document.getElementById("myModal");
    const closeButton = document.querySelector(".close-button");
    const modalTableId = document.getElementById("modal-table-id");
    const modalOrderList = document.getElementById("modal-order-list");
    const modalTotalPrice = document.getElementById("modal-total-price");
    const confirmButton = document.getElementById("confirm-button");
    const checkoutButton = document.getElementById("checkout-button");

    const tabs = document.querySelectorAll('.management-tab');
    const tablesContainer = document.getElementById('tables-container');
    const menuManagementContainer = document.getElementById('menu-management');
    const statisticsContainer = document.getElementById('statistics');
    const menuListManage = document.getElementById('menu-list-manage');
    const totalRevenue = document.getElementById('total-revenue');
    const topSellingItems = document.getElementById('top-selling-items');
    const resetStatsButton = document.getElementById('reset-stats-button');
    
    // 알림음
    const newOrderSound = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'init') {
        Object.assign(tables, data.tables);
        menu = data.menu;
        renderTables();
        renderMenuManage();
        fetchStatistics();
      } else if (data.type === 'table-update') {
        const oldStatus = tables[data.tableId].status;
        tables[data.tableId] = data.tableData;
        updateTableUI(data.tableId);
        if (oldStatus !== 'pending' && tables[data.tableId].status === 'pending') {
          playNewOrderSound();
        }
      } else if (data.type === 'menu-update') {
        menu = data.menu;
        renderMenuManage();
      } else if (data.type === 'sales-update') {
        fetchStatistics();
      }
    };
    
    function playNewOrderSound() {
        newOrderSound.play().catch(e => console.error("오디오 재생 오류:", e));
    }

    function renderTables() {
      sections.forEach(section => {
        const container = document.getElementById(section);
        container.innerHTML = '';
        for (let i = 1; i <= 6; i++) {
          const tableId = section + "-" + i;
          const table = document.createElement("div");
          table.id = tableId;
          table.className = "table";
          table.innerHTML = `<span class="table-id">${tableId}</span><div class="details"></div>`;
          container.appendChild(table);

          table.addEventListener("click", () => {
            showModal(tableId);
          });
        }
      });
      for (const tableId in tables) {
        updateTableUI(tableId);
      }
    }

    function updateTableUI(tableId) {
      const tableElement = document.getElementById(tableId);
      const tableData = tables[tableId];
      if (!tableElement || !tableData) return;

      const details = tableElement.querySelector('.details');
      tableElement.classList.remove("occupied", "pending");

      if (tableData.status === 'occupied') {
        tableElement.classList.add("occupied");
        
        let elapsedTime = '---';
        if (tableData.startTime) {
            elapsedTime = Math.floor((Date.now() - tableData.startTime) / 60000);
        }

        details.innerHTML = `점유 시간: ${elapsedTime}분<br>총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`;
      } else if (tableData.status === 'pending') {
        tableElement.classList.add("pending");
        details.innerHTML = `입금 대기<br>총 금액: ${tableData.totalPrice.toLocaleString('ko-KR')}원`;
      } else {
        details.innerHTML = "빈 테이블";
      }
    }

    function showModal(tableId) {
      const tableData = tables[tableId];
      modalTableId.textContent = tableId;
      modalOrderList.innerHTML = '';
      
      if (tableData.orders && tableData.orders.length > 0) {
        tableData.orders.forEach((order, index) => {
          const orderTitle = document.createElement('h4');
          orderTitle.style.marginTop = '10px';
          orderTitle.style.marginBottom = '5px';
          
          const orderDate = new Date(order.time);
          const formattedTime = orderDate.toLocaleTimeString('ko-KR', {
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            hour12: false
          });
          
          orderTitle.textContent = `주문 #${index + 1} (${formattedTime})`;
          modalOrderList.appendChild(orderTitle);

          const orderItemsList = document.createElement('ul');
          orderItemsList.style.listStyle = 'disc';
          orderItemsList.style.paddingLeft = '20px';
          orderItemsList.style.color = '#fff';

          if (order.items) {
            for (const itemName in order.items) {
              const item = order.items[itemName];
              const li = document.createElement('li');
              li.textContent = `${itemName} x ${item.quantity}`;
              orderItemsList.appendChild(li);
            }
          }
          modalOrderList.appendChild(orderItemsList);
        });
      } else {
        modalOrderList.innerHTML = '<li>주문 내역 없음</li>';
      }

      modalTotalPrice.textContent = tableData.totalPrice.toLocaleString('ko-KR');

      confirmButton.style.display = 'none';
      checkoutButton.style.display = 'none';

      if (tableData.status === 'pending') {
        confirmButton.style.display = 'block';
      } else if (tableData.status === 'occupied') {
        checkoutButton.style.display = 'block';
      }

      modal.style.display = "flex";
    }

    closeButton.onclick = () => {
      modal.style.display = "none";
    };

    window.onclick = (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    };

    confirmButton.onclick = () => {
      const tableId = modalTableId.textContent;
      ws.send(JSON.stringify({ type: 'confirm-order', tableId: tableId }));
      modal.style.display = 'none';
    };

    checkoutButton.onclick = () => {
      const tableId = modalTableId.textContent;
      const confirmation = confirm(`${tableId} 테이블을 정산하고 초기화하시겠습니까?`);
      if (confirmation) {
        ws.send(JSON.stringify({ type: 'checkout', tableId: tableId }));
        modal.style.display = 'none';
      }
    };

    setInterval(() => {
      for (const tableId in tables) {
        if (tables[tableId].status === 'occupied') {
          updateTableUI(tableId);
        }
      }
    }, 60000);

    // Tab Logic
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.dataset.tab;
            tablesContainer.style.display = 'none';
            menuManagementContainer.style.display = 'none';
            statisticsContainer.style.display = 'none';
            
            if (target === 'tables') {
                tablesContainer.style.display = 'grid';
            } else if (target === 'menu-management') {
                menuManagementContainer.style.display = 'block';
            } else if (target === 'statistics') {
                statisticsContainer.style.display = 'block';
                fetchStatistics();
            }
        });
    });
    
    // Menu Management
    function renderMenuManage() {
        menuListManage.innerHTML = '';
        menu.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item-manage';
            itemDiv.innerHTML = `
                <span class="menu-item-name">${item.name}</span>
                <button class="sold-out-toggle ${item.isSoldOut ? '' : 'available'}">${item.isSoldOut ? '품절' : '판매중'}</button>
            `;
            const toggleButton = itemDiv.querySelector('.sold-out-toggle');
            toggleButton.addEventListener('click', () => {
                item.isSoldOut = !item.isSoldOut;
                ws.send(JSON.stringify({ type: 'update-menu', menu: menu }));
            });
            menuListManage.appendChild(itemDiv);
        });
    }

    // Statistics
    function fetchStatistics() {
        fetch('/api/sales')
            .then(response => response.json())
            .then(salesData => {
                const totalSales = salesData.reduce((sum, sale) => sum + sale.totalPrice, 0);
                totalRevenue.textContent = totalSales.toLocaleString('ko-KR');

                const itemCounts = {};
                salesData.forEach(sale => {
                    sale.orders.forEach(order => {
                        for (const itemName in order.items) {
                            itemCounts[itemName] = (itemCounts[itemName] || 0) + order.items[itemName].quantity;
                        }
                    });
                });

                const sortedItems = Object.entries(itemCounts).sort(([, countA], [, countB]) => countB - countA);
                topSellingItems.innerHTML = '';
                if (sortedItems.length > 0) {
                    sortedItems.slice(0, 5).forEach(([name, count]) => {
                        const div = document.createElement('div');
                        div.className = 'stats-item';
                        div.textContent = `${name}: ${count}개`;
                        topSellingItems.appendChild(div);
                    });
                } else {
                    topSellingItems.innerHTML = `<div class="stats-item">판매 기록이 없습니다.</div>`;
                }
            })
            .catch(e => console.error('통계 데이터 불러오기 오류:', e));
    }
    
    resetStatsButton.addEventListener('click', () => {
        const confirmation = confirm("정말로 모든 판매 통계를 초기화하시겠습니까?");
        if (confirmation) {
            ws.send(JSON.stringify({ type: 'reset-sales' }));
        }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키오스크</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #1a1a1a;
            color: #ccc;
            margin: 0;
            padding-bottom: 80px;
        }
        h1, h2, h3, h4, h5 {
            color: #f5dd8f;
        }

        .kiosk-header {
            background-color: #1a1a1a;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .kiosk-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        .category-nav {
            display: flex;
            overflow-x: auto;
            background-color: #2a2a2a;
            padding: 10px 0;
            gap: 10px;
            position: sticky;
            top: 60px;
            z-index: 50;
        }
        .category-button {
            background-color: #4a4a4a;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: bold;
        }
        .category-button.active {
            background-color: #f5dd8f;
            color: black;
        }
        .menu-section {
            padding: 20px 10px;
            text-align: left;
        }
        .menu-section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
            color: white;
        }
        .menu-item {
            display: flex;
            background-color: #2a2a2a;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .menu-item.sold-out {
            opacity: 0.5;
            pointer-events: none;
        }
        .menu-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }
        .item-info-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1;
            text-align: left;
        }
        .item-name {
            font-size: 1.1em;
            font-weight: bold;
        }
        .item-price {
            font-size: 1em;
            color: #ccc;
        }
        .sold-out-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            z-index: 10;
            border-radius: 10px;
        }
        .quantity-controls-container {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .quantity-controls-container button {
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            border: 1px solid #555;
            background-color: #4a4a4a;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }
        .quantity-controls-container span {
            min-width: 25px;
            text-align: center;
            color: white;
            font-size: 1.1em;
        }
        .floating-cart-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #2a2a2a;
            color: white;
            padding: 10px 20px; /* 좌우 패딩 추가로 내용물이 끝에 붙지 않게 함 */
            display: flex;
            justify-content: center; /* 내용을 중앙으로 정렬 */
            align-items: center;
            gap: 20px; /* 요소 간 간격 추가 */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;

        }
        .floating-cart-bar.hidden {
            display: none;
        }
        .total-info {
            text-align: center;
        }
        .total-price-text {
            font-size: 1.1em;
            font-weight: bold;
        }
        .view-cart-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #f0f0f0;
            color: #333;
            padding: 10px;  /* 결제 모달 사이즈 수정 부분 */
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        #payment-modal .payment-section {
            background-color: white;
            padding: 5px;  /* 결제 모달 사이즈 수정 부분 */
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #payment-modal .payment-title { font-weight: bold; margin-bottom: 5px; }
        #payment-modal .payment-info { font-size: 1.1em; }
        #payment-modal .payment-amount { font-size: 2em; font-weight: bold; color: #007bff; }
        #payment-modal .account-number-text { font-weight: bold; }
        #payment-modal .large-button {
            width: 100%;
            font-size: 1.3em;
            font-weight: bold;
            padding: 15px 0;
            border: none;
            border-radius: 8px;
            margin-top: 15px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
        }
        #payment-modal .small-button {
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
            padding: 12px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            background-color: #ddd;
            color: #333;
        }
        #pending-modal .modal-content { background-color: #ffffff; color: #333; padding: 30px; border-radius: 15px; }
        .warning-icon {
            width: 60px;
            height: 60px;
            background-color: #f5dd8f;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: #fff;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        #pending-message-text { font-size: 1.2em; font-weight: bold; }
        #pending-sub-text { color: #888; margin: 5px 0; }
        #pending-table-id { color: #555; font-weight: bold; }

        /* New Cart Modal styles */
        #cart-modal .modal-content {
            background-color: #2a2a2a;
            color: white;
            text-align: left;
            padding: 20px;
            width: 80%; /* 이 값을 90% 등으로 늘려보세요. */
            max-width: 500px; /* 이 값을 500px 등으로 늘려보세요. */
        }
        #cart-modal .cart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        #cart-modal .cart-modal-header h3 {
            margin: 0;
            color: white;
        }
        #cart-modal .cart-modal-list {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 40vh;
        }
        #cart-modal .cart-modal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 10px;
            border-bottom: 1px solid #333;
        }
        #cart-modal .item-details {
            display: flex;
            flex-direction: column;
        }
        #cart-modal .item-subtotal-price {
            font-size: 1em;
            color: #ccc;
        }
        #cart-modal .cart-modal-summary {
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px;
        }
        #cart-modal .cart-modal-buttons {
            margin-top: 20px;
            text-align: center;
            padding: 0 10px;
        }
        #cart-modal #cart-order-button {
            width: 100%;
            font-size: 1.5em;
            font-weight: bold;
            padding: 15px 0;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        #cart-modal .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #cart-modal .quantity-controls button {
            width: 25px;
            height: 25px;
            font-size: 1em;
            cursor: pointer;
            border: 1px solid #555;
            background-color: #4a4a4a;
            color: white;
            border-radius: 50%;
        }
        #cart-modal .quantity-controls span {
            min-width: 20px;
            text-align: center;
            color: white;
            font-size: 1em;
        }
        .cart-modal-header .close-button {
            font-size: 2em;
            color: #ccc;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="kiosk-content">
    <div class="kiosk-header">
        <h2 id="table-title"></h2>
    </div>
    
    <div id="category-nav" class="category-nav"></div>

    <div id="menu-sections"></div>

    <div id="floating-cart-bar" class="floating-cart-bar hidden">
        <div class="total-info">
            <span id="total-items">0</span>개 / 
            <span id="total-price-display">0</span>원
        </div>
        <button id="view-cart-button" class="view-cart-button">장바구니 보기</button>
    </div>
</div>

<div id="cart-modal" class="modal">
    <div class="modal-content">
        <div class="cart-modal-header">
            <h3>장바구니</h3>
            <span class="close-button" id="cart-close-button">&times;</span>
        </div>
        <div id="cart-modal-list" class="cart-modal-list"></div>
        <div class="cart-modal-summary">
            <span>총합</span>
            <span id="cart-modal-total-price">₩0</span>
        </div>
        <div class="cart-modal-buttons">
            <button id="cart-order-button">주문하기</button>
        </div>
    </div>
</div>

<div id="payment-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>계좌이체 결제</h3>
        <div class="payment-section">
            <p class="payment-title">테이블</p>
            <p class="payment-info" id="modal-table-id"></p>
        </div>
        <div class="payment-section">
            <p class="payment-title">결제 금액</p>
            <p class="payment-info" id="modal-total-price-display"></p>
        </div>
        <div class="payment-section">
            <p class="payment-title">입금 계좌</p>
            <p class="payment-info account-number-text">우리은행 1002-065-148259 황성주</p>
        </div>
        <button id="copy-button" class="action-button" style="background-color: #007bff; color: white; padding: 12px; margin-top: 10px;">
            계좌번호 복사하기
        </button>
        <p style="margin-top: 20px; color: #888;">이체 후 아래 '이체 완료' 버튼을 눌러주세요</p>
        <button id="transfer-done-button" class="large-button">이체 완료</button>
        <button id="cancel-button" class="small-button">취소</button>
    </div>
</div>

<div id="pending-modal" class="modal">
    <div class="modal-content">
        <div class="warning-icon">!</div>
        <div id="pending-message-text">입금 확인 중</div>
        <p id="pending-sub-text">관리자가 입금을 확인하는 중입니다.<br>잠시만 기다려주세요.</p>
        <p id="pending-table-id"></p>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const tableId = urlParams.get('tableId');
    const tableTitle = document.getElementById('table-title');
    const categoryNav = document.getElementById('category-nav');
    const menuSections = document.getElementById('menu-sections');
    const floatingCartBar = document.getElementById('floating-cart-bar');
    const totalItemsSpan = document.getElementById('total-items');
    const totalPriceDisplay = document.getElementById('total-price-display');
    const viewCartButton = document.getElementById('view-cart-button');
    const cartModal = document.getElementById('cart-modal');
    const cartModalList = document.getElementById('cart-modal-list');
    const cartModalTotalPrice = document.getElementById('cart-modal-total-price');
    const cartOrderButton = document.getElementById('cart-order-button');
    const cartCloseButton = document.getElementById('cart-close-button');
    const paymentModal = document.getElementById('payment-modal');
    const pendingModal = document.getElementById('pending-modal');
    const modalTableId = document.getElementById('modal-table-id');
    const pendingModalTableId = document.getElementById('pending-table-id');
    const modalTotalPriceDisplay = document.getElementById('modal-total-price-display');
    const copyButton = document.getElementById('copy-button');
    const transferDoneButton = document.getElementById('transfer-done-button');
    const cancelButton = document.getElementById('cancel-button');
    const modalCloseButtons = document.querySelectorAll('.close-button');

    let menu = [];
    let cart = {};
    let isPending = false;

    if (tableId) {
        tableTitle.textContent = `${tableId} 테이블`;
        modalTableId.textContent = tableId;
        pendingModalTableId.textContent = tableId;
    } else {
        tableTitle.textContent = "테이블을 찾을 수 없습니다.";
    }

    const ws = new WebSocket("wss://daedongje-table-manager.onrender.com");

    ws.onopen = () => {
        if (tableId) {
            ws.send(JSON.stringify({ type: 'occupy', tableId: tableId }));
        }
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'init' || data.type === 'menu-update') {
            menu = data.menu;
            renderMenu();
            updateCartUI();
            if (cartModal.style.display === 'flex') {
                renderCartModal();
            }
        } else if (isPending && data.type === 'order-confirmed' && data.tableId === tableId) {
            isPending = false;
            if (pendingModal) pendingModal.style.display = 'none';
            alert('주문이 정상적으로 접수되었습니다!');
            setTimeout(() => {
                window.location.reload();
            }, 100);
        } else if (data.type === 'order-cancelled') {
            isPending = false;
            pendingModal.style.display = 'none'; // 혹시 '입금 확인 중' 창이 떠있으면 닫기
            alert('관리자에 의해 주문이 취소되었습니다. 메뉴를 다시 선택해주세요.');
            window.location.reload();
        }
    };

    function renderMenu() {
        menuSections.innerHTML = '';
        const categories = [...new Set(menu.map(item => item.category))];
        categoryNav.innerHTML = '';

        categories.forEach(category => {
            const button = document.createElement('button');
            button.className = 'category-button';
            button.textContent = category;
            button.addEventListener('click', () => {
                document.getElementById(`section-${category}`).scrollIntoView({
                    behavior: 'smooth'
                });
                document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
            categoryNav.appendChild(button);

            const section = document.createElement('div');
            section.className = 'menu-section';
            section.id = `section-${category}`;
            section.innerHTML = `<h3 class="menu-section-title">${category}</h3>`;
            
            menu.filter(item => item.category === category).forEach(item => {
                const menuItemDiv = document.createElement('div');
                menuItemDiv.className = 'menu-item';
                
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.name;

                const itemInfoContainer = document.createElement('div');
                itemInfoContainer.className = 'item-info-container';
                itemInfoContainer.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${item.price.toLocaleString('ko-KR')}원</div>
                `;

                const quantityControlsContainer = document.createElement('div');
                quantityControlsContainer.className = 'quantity-controls-container';
                
                const minusBtn = document.createElement('button');
                minusBtn.textContent = '-';
                minusBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    adjustQuantity(item.name, -1);
                });
                
                const quantitySpan = document.createElement('span');
                quantitySpan.textContent = cart[item.name] ? cart[item.name].quantity : 0;
                quantitySpan.style.color = '#fff';

                const plusBtn = document.createElement('button');
                plusBtn.textContent = '+';
                plusBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (!item.isSoldOut) {
                        adjustQuantity(item.name, 1);
                    }
                });
                
                quantityControlsContainer.appendChild(minusBtn);
                quantityControlsContainer.appendChild(quantitySpan);
                quantityControlsContainer.appendChild(plusBtn);

                menuItemDiv.appendChild(img);
                menuItemDiv.appendChild(itemInfoContainer);
                menuItemDiv.appendChild(quantityControlsContainer);

                if (item.isSoldOut) {
                    const overlay = document.createElement('div');
                    overlay.className = 'sold-out-overlay';
                    overlay.textContent = '품절';
                    menuItemDiv.appendChild(overlay);
                }
                section.appendChild(menuItemDiv);
            });
            menuSections.appendChild(section);
        });

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const category = entry.target.id.replace('section-', '');
                    document.querySelectorAll('.category-button').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent === category) {
                            btn.classList.add('active');
                        }
                    });
                }
            });
        }, { rootMargin: '-50% 0px -50% 0px' });
        
        document.querySelectorAll('.menu-section').forEach(section => {
            observer.observe(section);
        });
        
        if (categories.length > 0) {
            document.querySelector('.category-button').classList.add('active');
        }
    }

    function adjustQuantity(itemName, amount) {
        const itemData = menu.find(m => m.name === itemName);
        if (cart[itemName]) {
            cart[itemName].quantity += amount;
            if (cart[itemName].quantity <= 0) {
                delete cart[itemName];
            }
        } else if (amount > 0) {
            cart[itemName] = { quantity: 1, price: itemData.price };
        }
        updateCartUI();
        renderMenu(); // 메뉴 화면의 수량 표시 업데이트
        if (cartModal.style.display === 'flex') { // 장바구니 모달이 열려있으면 업데이트
            renderCartModal();
        }
    }

    function calculateTotalPrice() {
        let total = 0;
        for (const itemName in cart) {
            const itemData = menu.find(m => m.name === itemName);
            if (itemData) {
                total += cart[itemName].quantity * itemData.price;
            }
        }
        return total;
    }

    function updateCartUI() {
        const totalItemsCount = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
        const total = calculateTotalPrice();
        
        totalItemsSpan.textContent = totalItemsCount;
        totalPriceDisplay.textContent = total.toLocaleString('ko-KR');

        if (totalItemsCount > 0) {
            floatingCartBar.classList.remove('hidden');
        } else {
            floatingCartBar.classList.add('hidden');
        }
    }

    viewCartButton.addEventListener('click', () => {
        if (calculateTotalPrice() > 0) {
            renderCartModal();
            cartModal.style.display = 'flex';
        } else {
            alert("장바구니에 상품을 담아주세요.");
        }
    });

    cartOrderButton.addEventListener('click', () => {
        cartModal.style.display = 'none';
        updatePaymentModal();
        paymentModal.style.display = 'flex';
    });

    cartCloseButton.addEventListener('click', () => {
        cartModal.style.display = 'none';
    });

    cancelButton.addEventListener('click', () => {
        paymentModal.style.display = 'none';
    });

    transferDoneButton.addEventListener('click', () => {
        if (calculateTotalPrice() > 0) {
            isPending = true;
            ws.send(JSON.stringify({
                type: 'order-pending',
                tableId: tableId,
                items: cart,
                totalPrice: calculateTotalPrice()
            }));
            paymentModal.style.display = 'none';
            pendingModal.style.display = 'flex';
        }
    });
    
    copyButton.addEventListener('click', () => {
        const accountNumber = document.querySelector('.account-number-text').textContent;
        navigator.clipboard.writeText(accountNumber.trim())
            .then(() => {
                alert('계좌번호가 복사되었습니다!');
            })
            .catch(err => {
                console.error('복사 실패:', err);
                alert('계좌번호 복사에 실패했습니다.');
            });
    });

    modalCloseButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            paymentModal.style.display = 'none';
        });
    });

    function updatePaymentModal() {
        modalTableId.textContent = tableId;
        modalTotalPriceDisplay.textContent = calculateTotalPrice().toLocaleString('ko-KR') + '원';
    }

    function renderCartModal() {
        cartModalList.innerHTML = '';
        for (const itemName in cart) {
            const itemData = menu.find(m => m.name === itemName);
            if (!itemData) continue;
            const cartItemDiv = document.createElement('div');
            cartItemDiv.className = 'cart-modal-item';
            cartItemDiv.innerHTML = `
                <div class="item-details">
                    <div class="item-name">${itemName}</div>
                    <div class="item-subtotal-price">${(cart[itemName].quantity * itemData.price).toLocaleString('ko-KR')}원</div>
                </div>
                <div class="quantity-controls">
                    <button>-</button>
                    <span>${cart[itemName].quantity}</span>
                    <button>+</button>
                </div>
            `;
            cartItemDiv.querySelector('button:first-of-type').addEventListener('click', () => {
                adjustQuantity(itemName, -1);
            });
            cartItemDiv.querySelector('button:last-of-type').addEventListener('click', () => {
                adjustQuantity(itemName, 1);
            });
            cartModalList.appendChild(cartItemDiv);
        }
        cartModalTotalPrice.textContent = '₩' + calculateTotalPrice().toLocaleString('ko-KR');
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>키오스크</title>
  <style>
    body { font-family: sans-serif; text-align: center; background-color: #193b59; color: white; margin: 0; }
    h1, h2 { color: #f5dd8f; }
    .menu-container { display: flex; flex-direction: column; align-items: center; margin: 20px auto; width: 90%; max-width: 600px; }
    .menu-item { background-color: white; color: black; padding: 15px; margin: 10px 0; border-radius: 8px; cursor: pointer; text-align: left; }
    .menu-item.sold-out { opacity: 0.5; pointer-events: none; }
    .item-name { font-weight: bold; font-size: 1.2em; }
    .item-price { font-size: 1.1em; color: #555; }
    .cart-container { background-color: #315b85; padding: 20px; margin: 20px auto; width: 90%; max-width: 600px; border-radius: 10px; }
    .cart-container.disabled { opacity: 0.5; pointer-events: none; }
    .cart-list { list-style: none; padding: 0; margin: 10px 0; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #5d8ab5; }
    .cart-item-info { text-align: left; }
    .cart-item-price { color: white; }
    .quantity-controls button { width: 30px; height: 30px; font-size: 1em; margin: 0 5px; cursor: pointer; border: none; background-color: #f5dd8f; color: black; border-radius: 5px; }
    #total-price { font-size: 1.5em; font-weight: bold; }
    #order-summary { display: none; margin-top: 20px; }
    #order-summary-box { background-color: #4a759e; padding: 20px; border-radius: 10px; }
    #order-summary p { font-size: 1.2em; }
    #order-summary span { font-weight: bold; color: #f5dd8f; }
    #pending-message { display: none; background-color: #4a759e; padding: 20px; border-radius: 10px; margin-top: 20px; }
    #copy-button {
      background-color: #f5dd8f;
      color: black;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1 id="table-title"></h1>
  <h2>메뉴판</h2>
  <div id="menu-container"></div>
  
  <div class="cart-container">
    <h3>장바구니</h3>
    <ul id="cart-list"></ul>
    <p>총 금액: <span id="total-price">0</span>원</p>
    <button id="order-button">주문하기</button>
  </div>

  <div id="order-summary">
    <div id="order-summary-box">
        <h3>주문 내역</h3>
        <ul id="final-order-list"></ul>
        <p>최종 금액: <span id="final-total-price">0</span>원</p>
        <p>계좌번호: <span id="account-number">우리은행 1002-359-457613 이웅재</span><button id="copy-button">복사</button></p>
        <button id="transfer-done-button">이체 완료</button>
    </div>
  </div>

  <div id="pending-message">
    <p>입금 확인을 기다리고 있습니다...</p>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const tableId = urlParams.get('tableId');
    const tableTitle = document.getElementById('table-title');
    const menuContainer = document.getElementById('menu-container');
    const cartContainer = document.querySelector('.cart-container');
    const cartList = document.getElementById('cart-list');
    const totalPriceSpan = document.getElementById('total-price');
    const orderButton = document.getElementById('order-button');
    const orderSummary = document.getElementById('order-summary');
    const finalOrderList = document.getElementById('final-order-list');
    const finalTotalPriceSpan = document.getElementById('final-total-price');
    const transferDoneButton = document.getElementById('transfer-done-button');
    const pendingMessage = document.getElementById('pending-message');
    const copyButton = document.getElementById('copy-button');
    const accountNumberSpan = document.getElementById('account-number');

    let cart = {};
    let totalPrice = 0;
    let isPending = false; 

    if (tableId) {
      tableTitle.textContent = `${tableId} 테이블`;
    } else {
      tableTitle.textContent = "테이블을 찾을 수 없습니다.";
      orderButton.disabled = true;
    }

    const ws = new WebSocket("wss://daedongje-table-manager.onrender.com");

    ws.onopen = () => {
        if (tableId) {
            ws.send(JSON.stringify({ type: 'occupy', tableId: tableId }));
        }
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'init' || data.type === 'menu-update') {
            renderMenu(data.menu);
        } else if (isPending && data.type === 'order-confirmed' && data.tableId === tableId) {
            isPending = false;
            pendingMessage.innerHTML = '<p>주문이 정상적으로 접수되었습니다!</p>';
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
    };

    function renderMenu(menuItems) {
        menuContainer.innerHTML = '';
        menuItems.forEach(item => {
            const menuItemDiv = document.createElement('div');
            menuItemDiv.className = 'menu-item';
            if (item.isSoldOut) {
                menuItemDiv.classList.add('sold-out');
            }
            menuItemDiv.dataset.itemName = item.name;
            menuItemDiv.dataset.price = item.price;
            menuItemDiv.innerHTML = `
                <div class="item-name">${item.name}</div>
                <div class="item-price">${item.price.toLocaleString('ko-KR')}원</div>
            `;
            menuItemDiv.addEventListener('click', () => {
                if (!item.isSoldOut) {
                    const itemName = item.name;
                    const itemPrice = item.price;
                    if (cart[itemName]) {
                        cart[itemName].quantity++;
                    } else {
                        cart[itemName] = { quantity: 1, price: itemPrice };
                    }
                    totalPrice += itemPrice;
                    updateCartUI();
                }
            });
            menuContainer.appendChild(menuItemDiv);
        });
    }

    orderButton.addEventListener('click', () => {
        if (totalPrice > 0) {
            updateOrderSummary();
            orderSummary.style.display = 'block';
            cartContainer.style.display = 'none';
        } else {
            alert("장바구니에 상품을 담아주세요.");
        }
    });

    transferDoneButton.addEventListener('click', () => {
        if (totalPrice > 0) {
            isPending = true;
            ws.send(JSON.stringify({
                type: 'order-pending',
                tableId: tableId,
                items: cart,
                totalPrice: totalPrice
            }));
            orderSummary.style.display = 'none';
            pendingMessage.style.display = 'block';
        }
    });
    
    copyButton.addEventListener('click', () => {
        const accountNumber = accountNumberSpan.textContent;
        navigator.clipboard.writeText(accountNumber.trim())
            .then(() => {
                alert('계좌번호가 복사되었습니다!');
            })
            .catch(err => {
                console.error('복사 실패:', err);
                alert('계좌번호 복사에 실패했습니다.');
            });
    });

    function updateCartUI() {
        cartList.innerHTML = '';
        for (const itemName in cart) {
            const item = cart[itemName];
            const li = document.createElement('li');
            li.className = 'cart-item';
            
            li.innerHTML = `
                <div class="cart-item-info">
                    ${itemName}
                    <div class="cart-item-price">
                        ${item.price.toLocaleString('ko-KR')}원
                    </div>
                </div>
                <div class="quantity-controls">
                    <button class="minus-btn">-</button>
                    <span>${item.quantity}</span>
                    <button class="plus-btn">+</button>
                </div>
            `;
            li.querySelector('.minus-btn').addEventListener('click', () => adjustQuantity(itemName, -1));
            li.querySelector('.plus-btn').addEventListener('click', () => adjustQuantity(itemName, 1));
            cartList.appendChild(li);
        }
        totalPriceSpan.textContent = totalPrice.toLocaleString('ko-KR');
    }

    function adjustQuantity(itemName, amount) {
        if (cart[itemName]) {
            cart[itemName].quantity += amount;
            totalPrice += cart[itemName].price * amount;

            if (cart[itemName].quantity <= 0) {
                delete cart[itemName];
            }
            updateCartUI();
        }
    }

    function updateOrderSummary() {
        finalOrderList.innerHTML = '';
        for (const itemName in cart) {
            const item = cart[itemName];
            const li = document.createElement('li');
            const itemSubtotal = item.quantity * item.price;
            li.textContent = `${itemName} x${item.quantity} (${itemSubtotal.toLocaleString('ko-KR')}원)`;
            finalOrderList.appendChild(li);
        }
        finalTotalPriceSpan.textContent = totalPrice.toLocaleString('ko-KR');
    }
  </script>
</body>
</html>